## 数据处理与特征构建流程

本项目的多模态脚本围绕两条主线：
- **CLIP 管线**：沿用 `classify_media.py` → `extract_features.py`，适合在本地 GPU/CPU 上离线推理。
- **Gemini/OpenAI 聚合站管线**：通过 `gemini_feature_pipeline.py` 调用远端模型（如 `gemini-2.5-flash`），用于对比或替代 CLIP 分类结果。

两条路径都会生成兼容的帖子级和日度聚合特征，可直接喂给 1GoldPred 下游模型。

---

### 0. 环境准备

1. 激活已有环境（示例：`conda activate WeiboA`）。
2. 若计划调用聚合站，确认已安装 `requests` 与 `google-generativeai`（只在 provider=`google` 时需要）。
3. 准备好原始微博 CSV（`output/金价`）及图片目录（`images/金价`）。

---

### 1. 可选：批量生成 CLIP 分类结果

`batch_classify.py` 会调用 CLIP 并输出帖子级／图片级结果，适合先检查分类质量。

```bash
python batch_classify.py \
    --csv-root output/金价 \
    --images-root images/金价 \
    --output-root batch_results \
    --profile mac-cpu \
    --image-proto-root prototypes \
    --start-date 2022-01-01 \
    --end-date   2022-12-31 \
    --keep-image-level
```

产物位于 `batch_results/`，包括 `posts/日期.csv`、`images/日期.csv` 以及 `summary.csv`。

---

### 2A. 时间序列特征（CLIP 版本）

`extract_features.py` 会内部调用 `classify_media.py`，直接产生日度特征；
若要开启交互特征（情绪×主题等），追加 `--enable-interactions`。

```bash
python extract_features.py \
    --csv-root output/金价 \
    --images-root images/金价 \
    --profile auto \
    --image-proto-root prototypes \
    --start-date 2022-01-01 \
    --end-date   2022-12-31 \
    --output feature_exports/gold_features_daily_2022.csv \
    --enable-interactions
```

- 日度结果写入 `feature_exports/gold_features_daily_2022.csv`（含基础计数、细分类比率、交互特征、OCR 统计）。
- 脚本还会输出 `feature_exports/quality_samples.csv`，可人工复核低置信度样本。

---

### 2B. 时间序列特征（Gemini/OpenAI 版本）

如需使用聚合站 `http://104.225.150.15:7860/v1` 的 `gemini-2.5-flash` 模型，改用 `gemini_feature_pipeline.py`：

```bash
export OPENAI_API_KEY=123456789  # 或者通过 --api-key 明传

python gemini_feature_pipeline.py \
    --provider openai \
    --openai-base-url http://104.225.150.15:7860/v1 \
    --openai-model gemini-2.5-flash \
    --csv-root output/金价 \
    --images-root images/金价 \
    --classified-output feature_exports/classified_posts_gemini.csv \
    --output feature_exports/gold_features_daily_gemini.csv \
    --enable-interactions
```

- `--mock` 可在开发阶段跳过真实请求；`--max-images`、`--request-pause` 用于控制成本和速率。
- 输出结构与 CLIP 版一致，可直接替换或对比。

---

### 3. 质量巡检与抽样

使用 `quality_report.py` 对指定日期的帖子 / 图片做抽样检查：

```bash
python quality_report.py \
    --posts batch_results/posts/2022-01-05.csv \
    --images batch_results/images/2022-01-05.csv \
    --ground-truth ground_truth_template.csv \
    --sample-size 30 \
    --output quality_report_20220105.json \
    --sample-output quality_samples_20220105.csv
```

如结合 Gemini 产物，可将 `--posts` 指向 `feature_exports/classified_posts_gemini.csv` 中对应日期的数据。

---

### 4. 下游建模

1. 将 `feature_exports/gold_features_daily*.csv` 拷贝或软链至 `1基于/1GoldPred/data/external/`。
2. 在 `1GoldPred` 项目中更新 `config.py`，指定新的特征文件路径（可在同仓 README 查阅示例）。
3. 使用现有训练脚本（TFT、LSTM 等）对齐回测。

---

### 常见问题

- **运行效率**：Gemini/OpenAI 模式为网络调用，建议先用 `--mock` 验证流程，再全量跑批。
- **缓存**：`gemini_feature_pipeline.py` 默认在 `feature_exports/gemini_cache/` 缓存模型响应，可重复利用。
- **低置信度阈值**：可通过 `--low-confidence-threshold` 调整两套管线在聚合时的告警标准。
- **文件忽略**：`.gitignore` 已屏蔽 `batch_results/`、`feature_exports/` 等目录，避免临时文件入库。
